name: CI-CD Backend

on:
  push:
    branches: ['master']
  pull_request:
    branches: ['master']

jobs:
  quality_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci


      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

  tests:
    runs-on: ubuntu-latest
    needs: quality_and_build
    env:
      KEYCLOAK_ISSUER: http://localhost:8081/realms/collector
      KEYCLOAK_CLIENT_ID: collector-api
      KEYCLOAK_CLIENT_SECRET: dummy-secret
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Unit tests
        run: npm test

      - name: E2E API tests
        run: npm run test:e2e

  security:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Audit deps (SCA)
        run: npm audit --audit-level=high || true

      - name: Tests with coverage
        run: npm run test:cov

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=collector-backend
            -Dsonar.organization=moudehan
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.spec.ts,**/*.e2e-spec.ts
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.qualitygate.wait=true

  build_and_docker:
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      - name: Build Docker image
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/collector-api:${{ github.sha }} .
          # docker push ghcr.io/${{ github.repository_owner }}/collector-api:${{ github.sha }}

  charge_test:
    runs-on: ubuntu-latest
    needs: build_and_docker
    env:
      TARGET_URL: http://localhost:4000
      KEYCLOAK_ISSUER: http://localhost:8081/realms/collector
      KEYCLOAK_CLIENT_ID: collector-api
      KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}
    steps:
      - name: Install siege and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y siege jq

      - name: Create Siege URL file
        run: |
          cat > siege-urls.txt <<EOF
          ${TARGET_URL}/users
          ${TARGET_URL}/notifications/my
          ${TARGET_URL}/articles
          EOF

              - name: Get access token from Keycloak
                run: |
                  TOKEN=$(curl -s \
                    -H "Content-Type: application/x-www-form-urlencoded" \
                    -d "client_id=${KEYCLOAK_CLIENT_ID}" \
                    -d "client_secret=${KEYCLOAK_CLIENT_SECRET}" \
                    -d "grant_type=client_credentials" \
                    "${KEYCLOAK_ISSUER}/protocol/openid-connect/token" \
                    | jq -r .access_token)

                  echo "TOKEN=$TOKEN"
                  echo "TOKEN=$TOKEN" >> $GITHUB_ENV

              - name: Run load tests on multiple API endpoints
                run: |
                  echo "Running load tests on endpoints from siege-urls.txt..."
                  siege -c 3 -t1M \
                    -H "Authorization: Bearer $TOKEN" \
                    -H "Content-Type: application/json" \
                    -f siege-urls.txt

  owasp_zap:
    runs-on: ubuntu-latest
    needs: load_tests
    env:
      API_PORT: 4000
      API_BASE_URL: http://localhost:4000
      KEYCLOAK_ISSUER: http://localhost:8081/realms/collector
      KEYCLOAK_CLIENT_ID: collector-api
      KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build API Docker image
        run: |
          docker build -t collector-api:${{ github.sha }} .

      - name: Run API container for ZAP
        run: |
          docker run -d --name collector-api -p ${API_PORT}:4000 collector-api:${{ github.sha }}
          echo "Waiting for API to be up..."
          curl --fail --retry 10 --retry-all-errors --retry-delay 3 ${API_BASE_URL}/health

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Get Keycloak token for ZAP (client_credentials)
        run: |
          TOKEN=$(curl -s \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=${KEYCLOAK_CLIENT_ID}" \
            -d "client_secret=${KEYCLOAK_CLIENT_SECRET}" \
            -d "grant_type=client_credentials" \
            "${KEYCLOAK_ISSUER}/protocol/openid-connect/token" \
            | jq -r .access_token)

          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: OWASP ZAP baseline scan (secured endpoints)
        uses: zaproxy/action-baseline@v0.15.0
        env:
          ZAP_AUTH_HEADER: Authorization
          ZAP_AUTH_HEADER_VALUE: Bearer ${{ env.TOKEN }}
        with:
          target: '${{ env.API_BASE_URL }}/articles'
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          cmd_options: '-a'
          fail_action: false

  # deploy_staging:
  #   runs-on: ubuntu-latest
  #   needs: build_and_docker
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #     - name: Configure kubectl
  #       run: |
  #         echo "TODO: configurer kubectl (KUBECONFIG ou context via secrets)"
  #     - name: Deploy to staging
  #       run: |
  #         kubectl apply -f k8s/deployment-api-staging.yaml
  #         # ou helm upgrade ...

  # deploy_prod:
  #   runs-on: ubuntu-latest
  #   needs: e2e_and_load_tests
  #   if: github.ref == 'refs/heads/main'
  #   environment:
  #     name: production
  #     url: https://api.collector.shop
  #   steps:
  #     - name: Manual approval gate
  #       run: echo "Cette étape nécessite l'approbation manuelle dans GitHub (environnement 'production')."

  #     - name: Deploy to prod
  #       run: |
  #         kubectl apply -f k8s/deployment-api-prod.yaml
